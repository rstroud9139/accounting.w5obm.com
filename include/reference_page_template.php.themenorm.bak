<?php
if (!isset($page_config) || !is_array($page_config)) {
    throw new RuntimeException('Page configuration is required for reference pages.');
}

$title = $page_config['title'] ?? 'Reference Library';
$subtitle = $page_config['subtitle'] ?? 'Practical resources curated by W5OBM mentors.';
$hero_icon = $page_config['hero_icon'] ?? 'fa-compass';
$hero_badge = $page_config['badge'] ?? 'Reference Library';
$hero_actions = $page_config['hero_actions'] ?? [];
$intro = $page_config['intro'] ?? [];
$highlights = $page_config['highlights'] ?? [];
$sections = $page_config['sections'] ?? [];
$resources = $page_config['resources'] ?? [];
$cta = $page_config['cta'] ?? null;
$meta = $page_config['meta'] ?? [];
$cssVersion = file_exists(__DIR__ . '/../css/w5obm-main.css') ? filemtime(__DIR__ . '/../css/w5obm-main.css') : time();
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <title><?= htmlspecialchars($title) ?> | W5OBM Reference Library</title>
    <?php include __DIR__ . '/header.php'; ?>
    <link rel="stylesheet" href="<?= BASE_URL ?>css/w5obm-main.css?v=<?= $cssVersion ?>">
    <?php @require_once __DIR__ . '/site_settings.php';
    $heroDefaults = function_exists('get_hero_defaults') ? get_hero_defaults() : []; ?>
    <style>
        /* Dynamic hero variables sourced from site settings */
        :root {
            --primary-blue: <?= htmlspecialchars(get_site_setting('primary_blue', $heroDefaults['gradient_start'] ?? '#031A54'), ENT_QUOTES, 'UTF-8'); ?>;
            --secondary-blue: <?= htmlspecialchars(get_site_setting('secondary_blue', $heroDefaults['gradient_end'] ?? '#145EFF'), ENT_QUOTES, 'UTF-8'); ?>;
            --accent-gold: <?= htmlspecialchars(get_site_setting('accent_gold', '#FFD700'), ENT_QUOTES, 'UTF-8'); ?>;
            --hero-overlay-from: <?= htmlspecialchars(get_site_setting('hero_overlay_from_rgba', 'rgba(3,26,84,0.85)'), ENT_QUOTES, 'UTF-8'); ?>;
            --hero-overlay-to: <?= htmlspecialchars(get_site_setting('hero_overlay_to_rgba', 'rgba(20,94,255,0.70)'), ENT_QUOTES, 'UTF-8'); ?>;
        }

        /* Unified hero overlay + stripe to match site pattern */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: #fff;
            padding: 5.5rem 0 4rem;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--hero-overlay-from) 0%, var(--hero-overlay-to) 100%);
            z-index: 1;
            opacity: .85;
        }

        .hero-section::after {
            content: '';
            position: absolute;
            top: -40%;
            right: -10%;
            width: 60%;
            height: 180%;
            background: rgba(255, 255, 255, .08);
            transform: rotate(15deg);
            z-index: 1;
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }
    </style>
</head>

<body class="references-page">
    <?php include __DIR__ . '/menu.php'; ?>

    <main>
        <?php $slug = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $title)); ?>
        <section class="hero-section" data-hero="references-<?= htmlspecialchars(trim($slug, '-')) ?>">
            <div class="container hero-content py-5">
                <div class="row g-4 align-items-center">
                    <div class="col-lg-7">
                        <div class="hero-logo mb-3">
                            <img src="<?= BASE_URL ?>images/badges/club_logo.png" alt="W5OBM Amateur Radio Club" class="club-hero-logo">
                        </div>
                        <span class="hero-badge">
                            <i class="fas <?= htmlspecialchars($hero_icon) ?> me-2"></i><?= htmlspecialchars($hero_badge) ?>
                        </span>
                        <h1 class="display-5 fw-bold mt-3"><?= htmlspecialchars($title) ?></h1>
                        <p class="lead text-white-50 mb-4"><?= htmlspecialchars($subtitle) ?></p>
                        <?php if (!empty($hero_actions)): ?>
                            <div class="hero-actions d-flex flex-wrap gap-3">
                                <?php foreach ($hero_actions as $action): ?>
                                    <a class="btn <?= htmlspecialchars($action['style'] ?? 'btn-light text-primary fw-bold') ?>"
                                        href="<?= htmlspecialchars($action['url'] ?? '#') ?>"
                                        <?= !empty($action['external']) ? 'target="_blank" rel="noopener"' : '' ?>>
                                        <?php if (!empty($action['icon'])): ?>
                                            <i class="fas <?= htmlspecialchars($action['icon']) ?> me-2"></i>
                                        <?php endif; ?>
                                        <?= htmlspecialchars($action['label'] ?? 'Learn more') ?>
                                    </a>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                    <?php if (!empty($highlights)): ?>
                        <div class="col-lg-5">
                            <div class="row g-3">
                                <?php foreach ($highlights as $highlight): ?>
                                    <div class="col-6">
                                        <div class="content-card text-center py-4">
                                            <?php if (!empty($highlight['value'])): ?>
                                                <div class="display-6 fw-bold text-primary"><?= htmlspecialchars($highlight['value']) ?></div>
                                            <?php endif; ?>
                                            <p class="text-muted small mb-0"><?= htmlspecialchars($highlight['label'] ?? '') ?></p>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </section>

        <?php if (!empty($intro)): ?>
            <section class="py-5 bg-light">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <?php foreach ($intro as $paragraph): ?>
                                <p class="fs-5 text-secondary mb-4"><?= htmlspecialchars($paragraph) ?></p>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
            </section>
        <?php endif; ?>

        <?php if (!empty($sections)): ?>
            <section class="py-5">
                <div class="container">
                    <div class="row g-4">
                        <?php foreach ($sections as $section): ?>
                            <?php $colClass = !empty($section['layout']) && $section['layout'] === 'full' ? 'col-12' : 'col-12 col-lg-6'; ?>
                            <div class="<?= $colClass ?>">
                                <div class="reference-card h-100">
                                    <?php if (!empty($section['icon'])): ?>
                                        <div class="reference-icon"><i class="fas <?= htmlspecialchars($section['icon']) ?>"></i></div>
                                    <?php endif; ?>
                                    <h3 class="fw-bold"><?= htmlspecialchars($section['title'] ?? '') ?></h3>
                                    <?php if (!empty($section['description'])): ?>
                                        <p class="text-muted"><?= htmlspecialchars($section['description']) ?></p>
                                    <?php endif; ?>

                                    <?php if (!empty($section['bullets'])): ?>
                                        <ul class="reference-items list-unstyled mb-0">
                                            <?php foreach ($section['bullets'] as $bullet): ?>
                                                <li><i class="fas fa-check-circle text-primary mt-1"></i><span><?= htmlspecialchars($bullet) ?></span></li>
                                            <?php endforeach; ?>
                                        </ul>
                                    <?php endif; ?>

                                    <?php if (!empty($section['items'])): ?>
                                        <ul class="reference-items list-unstyled mt-3 mb-0">
                                            <?php foreach ($section['items'] as $item): ?>
                                                <li>
                                                    <i class="fas <?= htmlspecialchars($item['icon'] ?? 'fa-arrow-right') ?> text-primary mt-1"></i>
                                                    <div>
                                                        <div class="fw-semibold">
                                                            <?php if (!empty($item['url'])): ?>
                                                                <a href="<?= htmlspecialchars($item['url']) ?>" <?= !empty($item['external']) ? 'target="_blank" rel="noopener"' : '' ?>>
                                                                    <?= htmlspecialchars($item['title'] ?? '') ?>
                                                                </a>
                                                            <?php else: ?>
                                                                <?= htmlspecialchars($item['title'] ?? '') ?>
                                                            <?php endif; ?>
                                                        </div>
                                                        <?php if (!empty($item['description'])): ?>
                                                            <div class="text-muted small"><?= htmlspecialchars($item['description']) ?></div>
                                                        <?php endif; ?>
                                                        <?php if (!empty($item['tag'])): ?>
                                                            <span class="badge bg-light text-primary mt-1"><?= htmlspecialchars($item['tag']) ?></span>
                                                        <?php endif; ?>
                                                    </div>
                                                </li>
                                            <?php endforeach; ?>
                                        </ul>
                                    <?php endif; ?>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                </div>
            </section>
        <?php endif; ?>

        <?php if (!empty($resources)): ?>
            <section class="py-5 bg-light">
                <div class="container">
                    <h3 class="fw-bold mb-3"><i class="fas fa-link me-2 text-primary"></i>Featured Resources</h3>
                    <div>
                        <?php foreach ($resources as $resource): ?>
                            <span class="resource-tag">
                                <?php if (!empty($resource['url'])): ?>
                                    <a href="<?= htmlspecialchars($resource['url']) ?>" class="text-decoration-none" <?= !empty($resource['external']) ? 'target="_blank" rel="noopener"' : '' ?>>
                                        <i class="fas <?= htmlspecialchars($resource['icon'] ?? 'fa-arrow-up-right-from-square') ?>"></i>
                                        <?= htmlspecialchars($resource['label'] ?? '') ?>
                                    </a>
                                <?php else: ?>
                                    <i class="fas <?= htmlspecialchars($resource['icon'] ?? 'fa-arrow-up-right-from-square') ?>"></i>
                                    <?= htmlspecialchars($resource['label'] ?? '') ?>
                                <?php endif; ?>
                            </span>
                        <?php endforeach; ?>
                    </div>
                </div>
            </section>
        <?php endif; ?>

        <?php if (!empty($cta)): ?>
            <section class="py-5">
                <div class="container">
                    <div class="reference-card text-center">
                        <h3 class="fw-bold mb-3"><?= htmlspecialchars($cta['title'] ?? 'Keep the library fresh') ?></h3>
                        <p class="text-muted mb-4"><?= htmlspecialchars($cta['description'] ?? '') ?></p>
                        <?php if (!empty($cta['button'])): ?>
                            <a class="btn btn-primary px-4" href="<?= htmlspecialchars($cta['button']['url'] ?? '#') ?>">
                                <?= htmlspecialchars($cta['button']['label'] ?? 'Share an Update') ?>
                            </a>
                        <?php endif; ?>
                    </div>
                </div>
            </section>
        <?php endif; ?>

        <section class="pb-5">
            <div class="container">
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <?php if (!empty($meta['updated'])): ?>
                        <div class="meta-note"><i class="fas fa-clock"></i> Updated <?= htmlspecialchars($meta['updated']) ?></div>
                    <?php endif; ?>
                    <?php if (!empty($meta['curator'])): ?>
                        <div class="meta-note"><i class="fas fa-user-shield"></i> Curator: <?= htmlspecialchars($meta['curator']) ?></div>
                    <?php endif; ?>
                </div>
            </div>
        </section>
    </main>

    <?php include __DIR__ . '/footer.php'; ?>
</body>

</html>